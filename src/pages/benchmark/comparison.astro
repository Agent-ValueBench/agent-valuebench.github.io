---
import BenchmarkLayout from '../../layouts/BenchmarkLayout.astro';
import { agents, valueSystems } from '../../data/benchmark';
const serializedAgents = JSON.stringify(agents);
const serializedSystems = JSON.stringify(valueSystems);
---
<BenchmarkLayout activeTab="comparison">
  <div class="space-y-10">
    <section class="card p-6">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <div class="text-xs uppercase tracking-wide text-ink-500">Comparison</div>
          <div class="mt-2 font-display text-2xl font-semibold text-ink-900">Compare multiple agents</div>
        </div>
        <button class="btn-ghost" type="button" id="swapAgents">Swap A / B</button>
      </div>
      <div class="mt-6 grid gap-4 lg:grid-cols-3">
        <div>
          <label class="text-xs uppercase tracking-wide text-ink-500">Agent A</label>
          <select id="agentA" class="mt-2 w-full rounded-xl border border-ink-200 bg-white/80 px-3 py-2 text-sm">
            {agents.map((agent) => (
              <option value={agent.id}>{agent.name}</option>
            ))}
          </select>
        </div>
        <div>
          <label class="text-xs uppercase tracking-wide text-ink-500">Agent B</label>
          <select id="agentB" class="mt-2 w-full rounded-xl border border-ink-200 bg-white/80 px-3 py-2 text-sm">
            {agents.map((agent) => (
              <option value={agent.id}>{agent.name}</option>
            ))}
          </select>
        </div>
        <div>
          <label class="text-xs uppercase tracking-wide text-ink-500">Agent C</label>
          <select id="agentC" class="mt-2 w-full rounded-xl border border-ink-200 bg-white/80 px-3 py-2 text-sm">
            {agents.map((agent) => (
              <option value={agent.id}>{agent.name}</option>
            ))}
          </select>
        </div>
      </div>
    </section>

    <section class="grid gap-6 lg:grid-cols-[1fr,1fr]">
      <div class="card p-6">
        <div class="text-sm font-semibold text-ink-800">Radar overlay</div>
        <div class="mt-4" id="comparisonRadar"></div>
        <div class="mt-4 flex flex-wrap gap-3 text-xs text-ink-600" id="legend"></div>
      </div>
      <div class="card p-6">
        <div class="text-sm font-semibold text-ink-800">Dimension comparison</div>
        <div class="mt-4 overflow-auto">
          <table class="w-full min-w-[420px] text-left text-sm">
            <thead class="text-xs uppercase text-ink-500">
              <tr>
                <th class="py-2 pr-4">Dimension</th>
                <th class="py-2 pr-4">A</th>
                <th class="py-2 pr-4">B</th>
                <th class="py-2">Î”</th>
              </tr>
            </thead>
            <tbody id="comparisonTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card p-6">
      <div class="text-xs uppercase tracking-wide text-ink-500">Case-level comparison</div>
      <div class="mt-2 font-display text-2xl font-semibold text-ink-900">Future evidence workspace</div>
      <div class="mt-4 text-sm text-ink-600">
        Placeholder for selecting a dimension + case and comparing multiple model responses side by side.
      </div>
    </section>
  </div>

  <script>
    const agents = JSON.parse(`{"agents":${serializedAgents}}`).agents;
    const systems = JSON.parse(`{"systems":${serializedSystems}}`).systems;

    const agentA = document.getElementById('agentA');
    const agentB = document.getElementById('agentB');
    const agentC = document.getElementById('agentC');
    const swapAgents = document.getElementById('swapAgents');
    const comparisonRadar = document.getElementById('comparisonRadar');
    const comparisonTable = document.getElementById('comparisonTable');
    const legend = document.getElementById('legend');

    const getFilters = () => {
      const params = new URLSearchParams(window.location.search);
      const stored = JSON.parse(localStorage.getItem('avb-filters') || 'null');
      return {
        system: params.get('system') || stored?.system || systems[0].id,
        dims: params.get('dims')?.split(',') || stored?.dims || [],
      };
    };

    const getAgent = (id) => agents.find((agent) => agent.id === id) || agents[0];

    const loadCompareFromStorage = () => {
      const stored = JSON.parse(localStorage.getItem('avb-compare') || '[]');
      if (stored.length) {
        agentA.value = stored[0] || agents[0].id;
        agentB.value = stored[1] || agents[1]?.id || agents[0].id;
        agentC.value = stored[2] || agents[2]?.id || agents[0].id;
      } else {
        agentA.value = agents[0].id;
        agentB.value = agents[1]?.id || agents[0].id;
        agentC.value = agents[2]?.id || agents[0].id;
      }
    };

    const renderRadar = (agentList, systemId, dims) => {
      const system = systems.find((s) => s.id === systemId) || systems[0];
      const dimensions = system.dimensions.filter((dim) => !dims.length || dims.includes(dim.id));
      const size = 240;
      const center = size / 2;
      const radius = 80;
      const colors = ['#2e8b57', '#5a64ff', '#f39b33'];

      const polygonFor = (agent) =>
        dimensions
          .map((dim, index) => {
            const score = agent.scores.find((s) => s.systemId === systemId && s.dimensionId === dim.id)?.score || 0;
            const angle = (Math.PI * 2 * index) / dimensions.length - Math.PI / 2;
            const r = (score / 100) * radius;
            const x = center + r * Math.cos(angle);
            const y = center + r * Math.sin(angle);
            return `${x},${y}`;
          })
          .join(' ');

      comparisonRadar.innerHTML = `
        <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" class="mx-auto">
          <circle cx="${center}" cy="${center}" r="${radius}" fill="none" stroke="#d9d2c7" stroke-dasharray="4 4" />
          <circle cx="${center}" cy="${center}" r="${radius * 0.66}" fill="none" stroke="#e6dfd5" />
          <circle cx="${center}" cy="${center}" r="${radius * 0.33}" fill="none" stroke="#efe8dd" />
          ${dimensions
            .map((_, index) => {
              const angle = (Math.PI * 2 * index) / dimensions.length - Math.PI / 2;
              const x = center + radius * Math.cos(angle);
              const y = center + radius * Math.sin(angle);
              return `<line x1="${center}" y1="${center}" x2="${x}" y2="${y}" stroke="#e6dfd5" />`;
            })
            .join('')}
          ${agentList
            .map(
              (agent, index) =>
                `<polygon points="${polygonFor(agent)}" fill="${colors[index]}33" stroke="${colors[index]}" stroke-width="2" />`
            )
            .join('')}
        </svg>
      `;
    };

    const renderTable = (agentOne, agentTwo, systemId, dims) => {
      const system = systems.find((s) => s.id === systemId) || systems[0];
      const dimensions = system.dimensions.filter((dim) => !dims.length || dims.includes(dim.id));
      comparisonTable.innerHTML = '';
      dimensions.forEach((dim) => {
        const scoreA = agentOne.scores.find((s) => s.systemId === systemId && s.dimensionId === dim.id)?.score || 0;
        const scoreB = agentTwo.scores.find((s) => s.systemId === systemId && s.dimensionId === dim.id)?.score || 0;
        const delta = scoreA - scoreB;
        const row = document.createElement('tr');
        row.className = 'border-t border-ink-100';
        row.innerHTML = `
          <td class="py-3 pr-4">${dim.name}</td>
          <td class="py-3 pr-4">${scoreA}</td>
          <td class="py-3 pr-4">${scoreB}</td>
          <td class="py-3 ${delta >= 0 ? 'text-moss-700' : 'text-amber-700'}">${delta > 0 ? '+' : ''}${delta}</td>
        `;
        comparisonTable.appendChild(row);
      });
    };

    const renderLegend = (agentList) => {
      const colors = ['#2e8b57', '#5a64ff', '#f39b33'];
      legend.innerHTML = '';
      agentList.forEach((agent, index) => {
        const item = document.createElement('div');
        item.className = 'flex items-center gap-2';
        item.innerHTML = `<span class="h-2 w-2 rounded-full" style="background:${colors[index]}"></span>${agent.name}`;
        legend.appendChild(item);
      });
    };

    const renderAll = () => {
      const { system, dims } = getFilters();
      const list = [getAgent(agentA.value), getAgent(agentB.value), getAgent(agentC.value)];
      renderRadar(list, system, dims);
      renderTable(list[0], list[1], system, dims);
      renderLegend(list);
    };

    loadCompareFromStorage();
    renderAll();

    [agentA, agentB, agentC].forEach((select) => select.addEventListener('change', renderAll));

    swapAgents.addEventListener('click', () => {
      const temp = agentA.value;
      agentA.value = agentB.value;
      agentB.value = temp;
      renderAll();
    });
  </script>
</BenchmarkLayout>
