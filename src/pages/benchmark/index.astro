---
import BenchmarkLayout from '../../layouts/BenchmarkLayout.astro';
import { agents, valueSystems, cases } from '../../data/benchmark';

const serializedAgents = JSON.stringify(agents);
const serializedSystems = JSON.stringify(valueSystems);
const serializedCases = JSON.stringify(cases);

const searchParams = Astro.url.searchParams;
const systemParam = searchParams.get('system');
const dimsParam = searchParams.get('dims');
const initialSystem =
  valueSystems.find((system) => system.id === systemParam) || valueSystems[0];
const initialDims = dimsParam ? dimsParam.split(',') : initialSystem.dimensions.map((dim) => dim.id);
const dimsToUse = initialDims.length ? initialDims : initialSystem.dimensions.map((dim) => dim.id);

---
<BenchmarkLayout activeTab="benchmarks">
  <div class="space-y-10">
    <script type="application/json" id="agentsData" set:html={serializedAgents}></script>
    <script type="application/json" id="systemsData" set:html={serializedSystems}></script>
    <script type="application/json" id="casesData" set:html={serializedCases}></script>
    <section class="card p-6" data-tab-panel="benchmarks">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <div class="text-sm uppercase tracking-wide text-ink-500">Value System Focus</div>
          <div class="mt-2 font-display text-3xl font-semibold text-ink-900">Explore dimensions within each system</div>
        </div>
        <div class="text-base text-ink-500">Quick switch systems (mirrors global filter).</div>
      </div>
      <div class="mt-6 flex flex-wrap gap-2" id="systemTags">
        {valueSystems.map((system) => (
          <button
            type="button"
            data-system-tag={system.id}
            class={`rounded-full border px-4 py-2 text-base font-semibold transition hover:border-ink-400 ${
              system.id === initialSystem.id ? 'border-ink-900 bg-ink-900 text-ink-50' : 'border-ink-200 bg-white/70 text-ink-700'
            }`}
          >
            {system.name}
          </button>
        ))}
      </div>
      <div class="mt-6 grid gap-4 md:grid-cols-2 lg:grid-cols-3" id="dimensionScoreGrid">
        {initialSystem.dimensions
          .filter((dim) => dimsToUse.includes(dim.id))
          .map((dim) => {
          const avg = Math.round(
            agents.reduce((sum, agent) => {
              const score =
                agent.scores.find(
                  (entry) => entry.systemId === initialSystem.id && entry.dimensionId === dim.id
                )?.score || 0;
              return sum + score;
            }, 0) / agents.length
          );
          return (
            <div
              class="rounded-2xl border border-ink-200 bg-white/80 px-4 py-4"
            >
              <div class="text-base font-semibold text-ink-800">{dim.name}</div>
              <div class="mt-1 text-sm text-ink-500">{dim.description}</div>
              <div class="mt-4 flex items-end justify-between">
                <div class="text-sm uppercase tracking-wide text-ink-400">Avg score</div>
                <div class="font-display text-3xl font-semibold text-ink-900">{avg}</div>
              </div>
            </div>
          );
        })}
      </div>

      <div class="mt-10 border-t border-ink-100 pt-8">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div>
            <div class="text-xs uppercase tracking-wide text-ink-500">Leaderboard</div>
            <div class="mt-2 font-display text-3xl font-semibold text-ink-900">Agent ranking for selected dimensions</div>
          </div>
          <div class="flex flex-col items-end gap-3">
            <div class="flex flex-wrap items-center justify-end gap-2 text-xs">
              <span class="uppercase tracking-wide text-ink-400">Compare list</span>
              <div class="flex flex-wrap items-center gap-2" id="compareQueue"></div>
            </div>
            <div class="flex flex-wrap gap-3">
              <input
                id="agentSearch"
                type="text"
                placeholder="Search agent..."
                class="rounded-full border border-ink-200 bg-white/80 px-4 py-2 text-sm"
              />
              <select id="sortSelect" class="rounded-full border border-ink-200 bg-white/80 px-3 py-2 text-sm">
                <option value="name-asc">Name (A â†’ Z)</option>
              </select>
            </div>
          </div>
        </div>
        <div class="mt-6 overflow-x-auto">
          <table class="w-full min-w-[900px] text-left text-base">
            <thead id="leaderboardHead" class="text-xs uppercase text-ink-500"></thead>
            <tbody id="leaderboardBody" class="text-ink-700"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card p-6" data-tab-panel="analysis" hidden>
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <div class="text-xs uppercase tracking-wide text-ink-500">Agent Analysis</div>
          <div class="mt-2 font-display text-2xl font-semibold text-ink-900">Single agent profile</div>
        </div>
        <button class="btn-ghost" type="button">Download (this agent results)</button>
      </div>
      <div class="mt-6 grid gap-6 lg:grid-cols-[240px,1fr]">
        <div>
          <label class="text-xs uppercase tracking-wide text-ink-500">Select Agent</label>
          <select id="agentSelect" class="mt-2 w-full rounded-xl border border-ink-200 bg-white/80 px-3 py-2 text-sm">
            {agents.map((agent) => (
              <option value={agent.id}>{agent.name}</option>
            ))}
          </select>
          <div class="mt-4 space-y-2 text-sm text-ink-600" id="agentMeta"></div>
        </div>
        <div class="grid gap-6 lg:grid-cols-2">
          <div class="rounded-2xl border border-ink-100 bg-white/80 p-5">
            <div class="text-sm font-semibold text-ink-800">Radar: Value dimensions</div>
            <div class="mt-4" id="radarChart"></div>
          </div>
          <div class="rounded-2xl border border-ink-100 bg-white/80 p-5">
            <div class="text-sm font-semibold text-ink-800">Bars: Dimension scores</div>
            <div class="mt-4 space-y-3" id="barChart"></div>
          </div>
        </div>
      </div>

      <div class="mt-10 border-t border-ink-100 pt-8">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div>
            <div class="text-xs uppercase tracking-wide text-ink-500">Case Evidence</div>
            <div class="mt-2 font-display text-2xl font-semibold text-ink-900">Model behavior snapshots</div>
          </div>
          <div class="text-sm text-ink-500">Placeholder cases (future evidence support)</div>
        </div>
        <div class="mt-6 grid gap-4 md:grid-cols-2" id="caseList"></div>
        <div class="mt-6 flex items-center justify-end gap-2 text-sm">
          <button class="btn-ghost" type="button">Previous</button>
          <button class="btn-ghost" type="button">Next</button>
        </div>
      </div>
    </section>

    <section class="card p-6" data-tab-panel="comparison" hidden>
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <div class="text-xs uppercase tracking-wide text-ink-500">Comparison</div>
          <div class="mt-2 font-display text-2xl font-semibold text-ink-900">Compare multiple agents</div>
        </div>
        <button class="btn-ghost" type="button" id="swapAgents">Swap</button>
      </div>
      <div class="mt-6 grid gap-4 md:grid-cols-2 xl:grid-cols-5" id="compareAgentsGrid">
        <div data-agent-slot="A" data-agent-slot-index="0" class="relative rounded-2xl border border-transparent p-2 transition">
          <label class="text-xs uppercase tracking-wide text-ink-500">Agent A</label>
          <select id="agentA" class="mt-2 w-full rounded-xl border border-ink-200 bg-white/80 px-3 py-2 text-sm">
            <option value="">Empty</option>
            {agents.map((agent) => (
              <option value={agent.id}>{agent.name}</option>
            ))}
          </select>
          <button type="button" class="absolute right-2 top-2 hidden h-5 w-5 items-center justify-center rounded-full bg-ink-100 text-xs text-ink-600 transition hover:bg-ink-200" data-compare-slot-remove="0" aria-label="Remove Agent A">&times;</button>
        </div>
        <div data-agent-slot="B" data-agent-slot-index="1" class="relative rounded-2xl border border-transparent p-2 transition">
          <label class="text-xs uppercase tracking-wide text-ink-500">Agent B</label>
          <select id="agentB" class="mt-2 w-full rounded-xl border border-ink-200 bg-white/80 px-3 py-2 text-sm">
            <option value="">Empty</option>
            {agents.map((agent) => (
              <option value={agent.id}>{agent.name}</option>
            ))}
          </select>
          <button type="button" class="absolute right-2 top-2 hidden h-5 w-5 items-center justify-center rounded-full bg-ink-100 text-xs text-ink-600 transition hover:bg-ink-200" data-compare-slot-remove="1" aria-label="Remove Agent B">&times;</button>
        </div>
        <div data-agent-slot="C" data-agent-slot-index="2" class="relative rounded-2xl border border-transparent p-2 transition">
          <label class="text-xs uppercase tracking-wide text-ink-500">Agent C</label>
          <select id="agentC" class="mt-2 w-full rounded-xl border border-ink-200 bg-white/80 px-3 py-2 text-sm">
            <option value="">Empty</option>
            {agents.map((agent) => (
              <option value={agent.id}>{agent.name}</option>
            ))}
          </select>
          <button type="button" class="absolute right-2 top-2 hidden h-5 w-5 items-center justify-center rounded-full bg-ink-100 text-xs text-ink-600 transition hover:bg-ink-200" data-compare-slot-remove="2" aria-label="Remove Agent C">&times;</button>
        </div>
        <div data-agent-slot="D" data-agent-slot-index="3" class="relative rounded-2xl border border-transparent p-2 transition">
          <label class="text-xs uppercase tracking-wide text-ink-500">Agent D</label>
          <select id="agentD" class="mt-2 w-full rounded-xl border border-ink-200 bg-white/80 px-3 py-2 text-sm">
            <option value="">Empty</option>
            {agents.map((agent) => (
              <option value={agent.id}>{agent.name}</option>
            ))}
          </select>
          <button type="button" class="absolute right-2 top-2 hidden h-5 w-5 items-center justify-center rounded-full bg-ink-100 text-xs text-ink-600 transition hover:bg-ink-200" data-compare-slot-remove="3" aria-label="Remove Agent D">&times;</button>
        </div>
        <div data-agent-slot="E" data-agent-slot-index="4" class="relative rounded-2xl border border-transparent p-2 transition">
          <label class="text-xs uppercase tracking-wide text-ink-500">Agent E</label>
          <select id="agentE" class="mt-2 w-full rounded-xl border border-ink-200 bg-white/80 px-3 py-2 text-sm">
            <option value="">Empty</option>
            {agents.map((agent) => (
              <option value={agent.id}>{agent.name}</option>
            ))}
          </select>
          <button type="button" class="absolute right-2 top-2 hidden h-5 w-5 items-center justify-center rounded-full bg-ink-100 text-xs text-ink-600 transition hover:bg-ink-200" data-compare-slot-remove="4" aria-label="Remove Agent E">&times;</button>
        </div>
      </div>

      <div class="mt-8 grid gap-6 lg:grid-cols-[1fr,1fr]">
        <div class="rounded-2xl border border-ink-100 bg-white/80 p-5">
          <div class="text-sm font-semibold text-ink-800">Radar overlay</div>
          <div class="mt-4" id="comparisonRadar"></div>
          <div class="mt-4 flex flex-wrap gap-3 text-xs text-ink-600" id="legend"></div>
        </div>
        <div class="rounded-2xl border border-ink-100 bg-white/80 p-5">
          <div class="text-sm font-semibold text-ink-800">Dimension comparison</div>
          <div class="mt-4 overflow-auto">
            <table class="w-full min-w-[420px] text-left text-sm">
              <thead class="text-xs uppercase text-ink-500">
                <tr>
                  <th class="py-2 pr-4">Dimension</th>
                  <th class="py-2 pr-4">A</th>
                  <th class="py-2 pr-4">B</th>
                  <th class="py-2">Î”</th>
                </tr>
              </thead>
              <tbody id="comparisonTable"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="mt-8 rounded-2xl border border-ink-100 bg-white/80 p-5">
        <div class="text-sm font-semibold text-ink-800">Dimension bars</div>
        <div class="mt-4 space-y-4" id="comparisonBars"></div>
      </div>

      <div class="mt-8 rounded-2xl border border-ink-100 bg-white/80 p-5">
        <div class="text-xs uppercase tracking-wide text-ink-500">Case-level comparison</div>
        <div class="mt-2 font-display text-2xl font-semibold text-ink-900">Future evidence workspace</div>
        <div class="mt-4 text-sm text-ink-600">
          Placeholder for selecting a dimension + case and comparing multiple model responses side by side.
        </div>
      </div>
    </section>
  </div>

  <script>
    (() => {
      const agents = JSON.parse(document.getElementById('agentsData').textContent);
      const systems = JSON.parse(document.getElementById('systemsData').textContent);
      const systemTags = document.getElementById('systemTags');
      const dimensionScoreGrid = document.getElementById('dimensionScoreGrid');
      const leaderboardHead = document.getElementById('leaderboardHead');
      const leaderboardBody = document.getElementById('leaderboardBody');
      const agentSearch = document.getElementById('agentSearch');
      const sortSelect = document.getElementById('sortSelect');
      const systemSelect = document.getElementById('systemSelect');
      const dimensionList = document.getElementById('dimensionList');
      const compareQueue = document.getElementById('compareQueue');
      const compareLimit = 5;

      const getFilters = () => {
        const params = new URLSearchParams(window.location.search);
        const stored = JSON.parse(localStorage.getItem('avb-filters') || 'null');
        const system = params.get('system') || stored?.system || systems[0].id;
        const dimsParam = params.get('dims');
        const hasStoredDims = stored && Array.isArray(stored.dims);
        const dims = dimsParam !== null
          ? dimsParam.split(',').filter(Boolean)
          : hasStoredDims
            ? stored.dims
            : (getSystem(system).dimensions.map((dim) => dim.id));
        return { system, dims };
      };

      const getSystem = (systemId) => systems.find((s) => s.id === systemId) || systems[0];

      const getFiltersFromUI = () => {
        if (!systemSelect || !dimensionList) {
          return getFilters();
        }
        const dims = Array.from(dimensionList.querySelectorAll('input[type="checkbox"]'))
          .filter((input) => input.checked)
          .map((input) => input.value);
        return { system: systemSelect.value, dims };
      };

      const scoreFor = (agent, systemId, dimId) =>
        agent.scores.find((score) => score.systemId === systemId && score.dimensionId === dimId)?.score ?? 0;

      const normalizeCompareList = (list) => {
        const validIds = new Set(agents.map((agent) => agent.id));
        const unique = [];
        list.forEach((id) => {
          if (validIds.has(id) && !unique.includes(id)) {
            unique.push(id);
          }
        });
        return unique.slice(0, compareLimit);
      };

      const getCompareList = () => {
        const stored = JSON.parse(localStorage.getItem('avb-compare') || '[]');
        const normalized = normalizeCompareList(Array.isArray(stored) ? stored : []);
        localStorage.setItem('avb-compare', JSON.stringify(normalized));
        return normalized;
      };

      const setCompareList = (list) => {
        const normalized = normalizeCompareList(list);
        localStorage.setItem('avb-compare', JSON.stringify(normalized));
        window.dispatchEvent(new CustomEvent('avb:compare', { detail: normalized }));
        return normalized;
      };

      const renderCompareQueue = () => {
        if (!compareQueue) return;
        const list = getCompareList();
        compareQueue.innerHTML = '';
        for (let i = 0; i < compareLimit; i += 1) {
          const id = list[i];
          const slot = document.createElement('div');
          slot.className = 'flex items-center gap-2 rounded-full border border-ink-200 bg-white/80 px-3 py-1 text-xs text-ink-700';
          if (id) {
            const agent = agents.find((item) => item.id === id);
            slot.innerHTML = `
              <span class="font-semibold">${agent ? agent.name : 'Unknown'}</span>
              <button type="button" class="inline-flex h-4 w-4 items-center justify-center rounded-full bg-ink-100 text-[10px] text-ink-600 transition hover:bg-ink-200" data-compare-remove="${id}" aria-label="Remove ${agent ? agent.name : 'agent'}">&times;</button>
            `;
          } else {
            slot.classList.add('text-ink-400');
            slot.textContent = 'Empty';
          }
          compareQueue.appendChild(slot);
        }
      };

      const syncCompareButtons = () => {
        const list = getCompareList();
        leaderboardBody.querySelectorAll('[data-compare]').forEach((button) => {
          const id = button.dataset.compare;
          if (list.includes(id)) {
            button.textContent = 'Added';
            button.classList.add('border-ink-900', 'text-ink-900');
          } else {
            button.textContent = '+ Compare';
            button.classList.remove('border-ink-900', 'text-ink-900');
          }
        });
      };

      const getSelectedDimensions = (systemId, dims) => {
        const system = getSystem(systemId);
        return system.dimensions.filter((dim) => dims.includes(dim.id));
      };

      const renderDimensionGrid = (override = null) => {
        const { system, dims } = override || getFilters();
        const systemData = getSystem(system);
        const dimsToShow = dims;
        dimensionScoreGrid.innerHTML = '';
        systemData.dimensions
          .filter((dim) => dimsToShow.includes(dim.id))
          .forEach((dim) => {
          const avg = Math.round(
            agents.reduce((sum, agent) => {
              const score = agent.scores.find((s) => s.systemId === system && s.dimensionId === dim.id)?.score || 0;
              return sum + score;
            }, 0) / agents.length
          );
          const card = document.createElement('div');
          card.className = 'rounded-2xl border border-ink-200 bg-white/80 px-4 py-4';
          card.innerHTML = `
            <div class="text-base font-semibold text-ink-800">${dim.name}</div>
            <div class="mt-1 text-sm text-ink-500">${dim.description}</div>
            <div class="mt-4 flex items-end justify-between">
              <div class="text-sm uppercase tracking-wide text-ink-400">Avg score</div>
              <div class="font-display text-3xl font-semibold text-ink-900">${avg}</div>
            </div>
          `;
          dimensionScoreGrid.appendChild(card);
        });
      };

      const renderLeaderboardHead = (selectedDimensions) => {
        const dimensionHeaders = selectedDimensions
          .map(
            (dim) => `
              <th class="py-3 pr-4">
                <button
                  type="button"
                  class="inline-flex items-center gap-1 font-semibold text-ink-500 transition hover:text-ink-900"
                  data-sort-dim="${dim.id}"
                  title="Sort by ${dim.name}"
                >
                  <span class="border-b border-dashed border-ink-300 pb-0.5">${dim.name}</span>
                </button>
              </th>
            `
          )
          .join('');
        leaderboardHead.innerHTML = `
          <tr>
            <th class="py-3 pr-4">Rank</th>
            <th class="py-3 pr-4">Agent Name</th>
            <th class="py-3 pr-4">Developer</th>
            ${dimensionHeaders}
            <th class="py-3 pr-4">Release Date</th>
            <th class="py-3 pr-4">Compare</th>
            <th class="py-3">Details</th>
          </tr>
        `;
      };

      const renderTable = (override = null) => {
        const { system, dims } = override || getFilters();
        const selectedDimensions = getSelectedDimensions(system, dims);
        renderLeaderboardHead(selectedDimensions);
        const search = agentSearch.value.toLowerCase();
        const rows = agents
          .filter((agent) => agent.name.toLowerCase().includes(search))
          .map((agent) => ({
            ...agent,
            dimensionScores: selectedDimensions.reduce((acc, dim) => {
              acc[dim.id] = scoreFor(agent, system, dim.id);
              return acc;
            }, {}),
          }));

        const sortValue = sortSelect.value || 'name-asc';
        const dimSortMatch = sortValue.startsWith('dim:') ? sortValue.slice(4) : null;
        const sorted = rows.sort((a, b) => {
          if (dimSortMatch) {
            const scoreA = a.dimensionScores[dimSortMatch] ?? 0;
            const scoreB = b.dimensionScores[dimSortMatch] ?? 0;
            if (scoreB !== scoreA) return scoreB - scoreA;
            return a.name.localeCompare(b.name);
          }
          return a.name.localeCompare(b.name);
        });

        const paged = sorted;
        leaderboardBody.innerHTML = '';

        const buildRankLabel = (rank, showBadge) => {
          if (!showBadge) return `${rank}`;
          const badgeMap = {
            1: 'ðŸ¥‡',
            2: 'ðŸ¥ˆ',
            3: 'ðŸ¥‰',
          };
          const badge = badgeMap[rank];
          if (!badge) return `${rank}`;
          return `<span class="inline-flex items-center gap-2">${badge}<span>${rank}</span></span>`;
        };

        const showRankBadges = Boolean(dimSortMatch);

        if (dimSortMatch) {
          sorted.forEach((agent, index) => {
            if (index === 0) {
              agent._rank = 1;
              return;
            }
            const prev = sorted[index - 1];
            const prevScore = prev.dimensionScores[dimSortMatch] ?? 0;
            const currentScore = agent.dimensionScores[dimSortMatch] ?? 0;
            agent._rank = currentScore === prevScore ? prev._rank : index + 1;
          });
        }

        paged.forEach((agent, index) => {
          const rank = dimSortMatch ? agent._rank : index + 1;
          const row = document.createElement('tr');
          row.className = 'border-t border-ink-100';
          const scoreCells = selectedDimensions
            .map((dim) => `<td class="py-4 pr-4 font-semibold text-ink-900">${agent.dimensionScores[dim.id] ?? 0}</td>`)
            .join('');
          row.innerHTML = `
            <td class="py-4 pr-4 font-semibold">${buildRankLabel(rank, showRankBadges)}</td>
            <td class="py-4 pr-4">
              <div class="font-semibold text-ink-900">${agent.name}</div>
              <div class="text-xs text-ink-500">${agent.type}</div>
            </td>
            <td class="py-4 pr-4">${agent.developer}</td>
            ${scoreCells}
            <td class="py-4 pr-4">${agent.releaseDate}</td>
            <td class="py-4 pr-4">
              <button class="inline-flex items-center whitespace-nowrap rounded-full border border-ink-200 px-3 py-1 text-xs font-semibold" data-compare="${agent.id}">+ Compare</button>
            </td>
            <td class="py-4">
              <button class="text-ink-700 underline" data-agent-view="${agent.id}">View</button>
            </td>
          `;
          leaderboardBody.appendChild(row);
        });
        syncCompareButtons();
      };

      const updateSortOptions = (override = null) => {
        const { system, dims } = override || getFilters();
        const selectedDimensions = getSelectedDimensions(system, dims);
        const currentValue = sortSelect.value || 'name-asc';
        sortSelect.innerHTML = '';
        const nameOption = document.createElement('option');
        nameOption.value = 'name-asc';
        nameOption.textContent = 'Name (A â†’ Z)';
        sortSelect.appendChild(nameOption);
        selectedDimensions.forEach((dim) => {
          const option = document.createElement('option');
          option.value = `dim:${dim.id}`;
          option.textContent = `${dim.name} (high â†’ low)`;
          sortSelect.appendChild(option);
        });
        const values = Array.from(sortSelect.options).map((option) => option.value);
        sortSelect.value = values.includes(currentValue) ? currentValue : 'name-asc';
      };

      const updateTabHighlight = (overrideSystem = null) => {
        const system = overrideSystem || getFilters().system;
        systemTags.querySelectorAll('button').forEach((btn) => {
          if (btn.dataset.systemTag === system) {
            btn.classList.add('bg-ink-900', 'text-ink-50', 'border-ink-900');
            btn.classList.remove('bg-white/70', 'text-ink-700', 'border-ink-200');
          } else {
            btn.classList.remove('bg-ink-900', 'text-ink-50', 'border-ink-900');
            btn.classList.add('bg-white/70', 'text-ink-700', 'border-ink-200');
          }
        });
      };

      const applyUiFilters = () => {
        const detail = getFiltersFromUI();
        updateTabHighlight(detail.system);
        updateSortOptions(detail);
        renderDimensionGrid(detail);
        renderTable(detail);
      };

      systemTags.addEventListener('click', (event) => {
        const btn = event.target.closest('button[data-system-tag]');
        if (!btn) return;
        window.avbSetSystem(btn.dataset.systemTag);
        window.avbSyncFilters();
      });

      document.addEventListener('click', (event) => {
        const compare = event.target.closest('[data-compare]');
        if (compare) {
          const id = compare.dataset.compare;
          const stored = getCompareList();
          if (!stored.includes(id) && stored.length < compareLimit) {
            stored.push(id);
            setCompareList(stored);
          }
          renderCompareQueue();
          syncCompareButtons();
          return;
        }
        const remove = event.target.closest('[data-compare-remove]');
        if (remove) {
          const id = remove.dataset.compareRemove;
          const stored = getCompareList().filter((item) => item !== id);
          setCompareList(stored);
          renderCompareQueue();
          syncCompareButtons();
          return;
        }
        const view = event.target.closest('[data-agent-view]');
        if (!view) return;
        const params = new URLSearchParams(window.location.search);
        params.set('agent', view.dataset.agentView);
        params.set('tab', 'analysis');
        window.avbUpdateParams(params);
        window.avbSetTab('analysis');
      });

      agentSearch.addEventListener('input', () => {
        renderTable();
      });
      sortSelect.addEventListener('change', () => {
        renderTable();
      });

      window.addEventListener('avb:filters', (event) => {
        const detail = event.detail || null;
        updateTabHighlight();
        updateSortOptions(detail);
        renderDimensionGrid(detail);
        renderTable(detail);
      });

      leaderboardHead.addEventListener('click', (event) => {
        const button = event.target.closest('[data-sort-dim]');
        if (!button) return;
        const dimId = button.dataset.sortDim;
        sortSelect.value = `dim:${dimId}`;
        renderTable();
      });

      if (systemSelect) {
        systemSelect.addEventListener('change', () => {
          requestAnimationFrame(applyUiFilters);
        });
      }
      if (dimensionList) {
        dimensionList.addEventListener('change', applyUiFilters);
      }

      updateTabHighlight();
      updateSortOptions();
      renderDimensionGrid();
      renderTable();
      renderCompareQueue();
      window.avbRefreshCompare = () => {
        renderCompareQueue();
        syncCompareButtons();
      };
    })();
  </script>

  <script>
    (() => {
      const agents = JSON.parse(document.getElementById('agentsData').textContent);
      const systems = JSON.parse(document.getElementById('systemsData').textContent);
      const cases = JSON.parse(document.getElementById('casesData').textContent);

      const agentSelect = document.getElementById('agentSelect');
      const agentMeta = document.getElementById('agentMeta');
      const radarChart = document.getElementById('radarChart');
      const barChart = document.getElementById('barChart');
      const caseList = document.getElementById('caseList');
      const systemSelect = document.getElementById('systemSelect');
      const dimensionList = document.getElementById('dimensionList');

      const getFilters = () => {
        const params = new URLSearchParams(window.location.search);
        const stored = JSON.parse(localStorage.getItem('avb-filters') || 'null');
        const system = params.get('system') || stored?.system || systems[0].id;
        const dimsParam = params.get('dims');
        const hasStoredDims = stored && Array.isArray(stored.dims);
        const dims = dimsParam !== null
          ? dimsParam.split(',').filter(Boolean)
          : hasStoredDims
            ? stored.dims
            : (systems.find((s) => s.id === system) || systems[0]).dimensions.map((dim) => dim.id);
        return { system, dims };
      };

      const getAgent = (id) => agents.find((agent) => agent.id === id) || agents[0];

      const renderMeta = (agent) => {
        agentMeta.innerHTML = `
          <div><strong>Developer:</strong> ${agent.developer}</div>
          <div><strong>Website/GitHub:</strong> <a class="underline" href="${agent.website}">${agent.website}</a></div>
          <div><strong>Paper/report:</strong> <a class="underline" href="${agent.paper}">${agent.paper}</a></div>
          <div><strong>Type:</strong> ${agent.type}</div>
          <div><strong>Publish date:</strong> ${agent.releaseDate}</div>
          <div><strong>Measurement date:</strong> ${agent.measurementDate}</div>
        `;
      };

      const renderRadar = (agent, systemId, dims) => {
        const system = systems.find((s) => s.id === systemId) || systems[0];
        const dimensions = system.dimensions.filter((dim) => dims.includes(dim.id));
        const size = 220;
        const center = size / 2;
        const radius = 80;
        const points = dimensions.map((dim, index) => {
          const score = agent.scores.find((s) => s.systemId === systemId && s.dimensionId === dim.id)?.score || 0;
          const angle = (Math.PI * 2 * index) / dimensions.length - Math.PI / 2;
          const r = (score / 100) * radius;
          const labelText = dim.name;
          const shortLabel = labelText.length > 12 ? `${labelText.slice(0, 12)}â€¦` : labelText;
          return {
            x: center + r * Math.cos(angle),
            y: center + r * Math.sin(angle),
            labelX: center + (radius + 18) * Math.cos(angle),
            labelY: center + (radius + 18) * Math.sin(angle),
            label: shortLabel,
            fullLabel: labelText,
          };
        });

        const polygon = points.map((p) => `${p.x},${p.y}`).join(' ');

        radarChart.innerHTML = `
          <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" class="mx-auto">
            <circle cx="${center}" cy="${center}" r="${radius}" fill="none" stroke="#d9d2c7" stroke-dasharray="4 4" />
            <circle cx="${center}" cy="${center}" r="${radius * 0.66}" fill="none" stroke="#e6dfd5" />
            <circle cx="${center}" cy="${center}" r="${radius * 0.33}" fill="none" stroke="#efe8dd" />
            ${points
              .map(
                (p) => `<line x1="${center}" y1="${center}" x2="${p.x}" y2="${p.y}" stroke="#e6dfd5" />`
              )
              .join('')}
            <polygon points="${polygon}" fill="rgba(46, 139, 87, 0.35)" stroke="#2e8b57" stroke-width="2" />
            ${points
              .map(
                (p) => `<text x="${p.labelX}" y="${p.labelY}" text-anchor="middle" font-size="10" fill="#6f5435">
                  <title>${p.fullLabel}</title>${p.label}
                </text>`
              )
              .join('')}
          </svg>
        `;
      };

      const renderBars = (agent, systemId, dims) => {
        const system = systems.find((s) => s.id === systemId) || systems[0];
        const dimensions = system.dimensions.filter((dim) => dims.includes(dim.id));
        barChart.innerHTML = '';
        dimensions.forEach((dim) => {
          const score = agent.scores.find((s) => s.systemId === systemId && s.dimensionId === dim.id)?.score || 0;
          const row = document.createElement('div');
          row.innerHTML = `
            <div class="flex items-center justify-between text-xs text-ink-600">
              <span>${dim.name}</span>
              <span>${score}</span>
            </div>
            <div class="mt-2 h-2 rounded-full bg-ink-100">
              <div class="h-2 rounded-full bg-ink-900" style="width: ${score}%;"></div>
            </div>
          `;
          barChart.appendChild(row);
        });
      };

      const renderCases = (systemId, dims) => {
        const filtered = cases.filter((item) => item.systemId === systemId && dims.includes(item.dimensionId));
        caseList.innerHTML = '';
        filtered.forEach((item) => {
          const card = document.createElement('div');
          card.className = 'rounded-2xl border border-ink-100 bg-white/80 p-4';
          card.innerHTML = `
            <div class="text-xs uppercase tracking-wide text-ink-400">Case score ${item.score}</div>
            <div class="mt-2 text-sm font-semibold text-ink-800">${item.question}</div>
            <div class="mt-2 text-xs text-ink-600">${item.summary}</div>
            <button class="mt-4 rounded-full border border-ink-200 px-3 py-1 text-xs font-semibold">Copy</button>
          `;
          caseList.appendChild(card);
        });
      };

      const syncAgentFromQuery = () => {
        const params = new URLSearchParams(window.location.search);
        const agentId = params.get('agent');
        if (agentId && agents.find((a) => a.id === agentId)) {
          agentSelect.value = agentId;
        }
      };

      const renderAll = () => {
        const { system, dims } = getFilters();
        const agent = getAgent(agentSelect.value);
        renderMeta(agent);
        renderRadar(agent, system, dims);
        renderBars(agent, system, dims);
        renderCases(system, dims);
      };

      syncAgentFromQuery();
      renderAll();

      agentSelect.addEventListener('change', () => {
        const params = new URLSearchParams(window.location.search);
        params.set('agent', agentSelect.value);
        window.avbUpdateParams(params);
        renderAll();
      });

      window.addEventListener('avb:filters', renderAll);
      window.addEventListener('avb:compare', (event) => {
        const list = Array.isArray(event.detail) ? event.detail : getCompareList();
        applyListToSelects(list);
        renderAll();
      });
      window.addEventListener('avb:tab', syncAgentFromQuery);

      if (systemSelect) {
        systemSelect.addEventListener('change', () => requestAnimationFrame(renderAll));
      }
      if (dimensionList) {
        dimensionList.addEventListener('change', renderAll);
      }
    })();
  </script>

  <script>
    (() => {
      const agents = JSON.parse(document.getElementById('agentsData').textContent);
      const systems = JSON.parse(document.getElementById('systemsData').textContent);

      const agentA = document.getElementById('agentA');
      const agentB = document.getElementById('agentB');
      const agentC = document.getElementById('agentC');
      const agentD = document.getElementById('agentD');
      const agentE = document.getElementById('agentE');
      const swapAgents = document.getElementById('swapAgents');
      const compareAgentsGrid = document.getElementById('compareAgentsGrid');
      const comparisonRadar = document.getElementById('comparisonRadar');
      const comparisonTable = document.getElementById('comparisonTable');
      const comparisonBars = document.getElementById('comparisonBars');
      const legend = document.getElementById('legend');
      const systemSelect = document.getElementById('systemSelect');
      const dimensionList = document.getElementById('dimensionList');
      const compareLimit = 5;
      const agentSelects = [agentA, agentB, agentC, agentD, agentE];
      let swapActive = false;
      let swapSelection = [];

      const getFilters = () => {
        const params = new URLSearchParams(window.location.search);
        const stored = JSON.parse(localStorage.getItem('avb-filters') || 'null');
        const system = params.get('system') || stored?.system || systems[0].id;
        const dimsParam = params.get('dims');
        const hasStoredDims = stored && Array.isArray(stored.dims);
        const dims = dimsParam !== null
          ? dimsParam.split(',').filter(Boolean)
          : hasStoredDims
            ? stored.dims
            : (systems.find((s) => s.id === system) || systems[0]).dimensions.map((dim) => dim.id);
        return { system, dims };
      };

      const getAgent = (id) => agents.find((agent) => agent.id === id) || null;

      const normalizeCompareList = (list) => {
        const validIds = new Set(agents.map((agent) => agent.id));
        const unique = [];
        list.forEach((id) => {
          if (validIds.has(id) && !unique.includes(id)) {
            unique.push(id);
          }
        });
        return unique.slice(0, compareLimit);
      };

      const getCompareList = () => {
        const stored = JSON.parse(localStorage.getItem('avb-compare') || '[]');
        const normalized = normalizeCompareList(Array.isArray(stored) ? stored : []);
        localStorage.setItem('avb-compare', JSON.stringify(normalized));
        return normalized;
      };

      const setCompareList = (list) => {
        const normalized = normalizeCompareList(list);
        localStorage.setItem('avb-compare', JSON.stringify(normalized));
        window.dispatchEvent(new CustomEvent('avb:compare', { detail: normalized }));
        if (window.avbRefreshCompare) {
          window.avbRefreshCompare();
        }
        return normalized;
      };

      const updateRemoveButtons = () => {
        compareAgentsGrid.querySelectorAll('[data-compare-slot-remove]').forEach((button) => {
          const index = Number(button.dataset.compareSlotRemove);
          const hasAgent = Boolean(agentSelects[index]?.value);
          button.classList.toggle('hidden', !hasAgent);
          button.classList.toggle('inline-flex', hasAgent);
        });
      };

      const updateSelectOptions = () => {
        const selected = agentSelects.map((select) => select.value).filter(Boolean);
        agentSelects.forEach((select) => {
          Array.from(select.options).forEach((option) => {
            if (!option.value) {
              option.disabled = false;
              return;
            }
            const taken = selected.includes(option.value) && option.value !== select.value;
            option.disabled = taken;
          });
        });
      };

      const updateSwapHints = () => {
        compareAgentsGrid.querySelectorAll('[data-agent-slot]').forEach((slot, index) => {
          const hasAgent = Boolean(agentSelects[index]?.value);
          slot.classList.toggle('cursor-pointer', swapActive && hasAgent);
          slot.classList.toggle('border-ink-200', swapActive && hasAgent);
          slot.classList.toggle('bg-ink-50/40', swapActive && hasAgent);
        });
      };

      const updateSwapLockState = () => {
        agentSelects.forEach((select) => {
          select.disabled = swapActive;
          select.classList.toggle('opacity-60', swapActive);
          select.classList.toggle('cursor-not-allowed', swapActive);
        });
      };

      const applyListToSelects = (list) => {
        agentSelects.forEach((select, index) => {
          select.value = list[index] || '';
        });
        updateSelectOptions();
        updateRemoveButtons();
        updateSwapHints();
      };

      const syncCompareFromSelects = () => {
        const list = [];
        agentSelects.forEach((select) => {
          const value = select.value;
          if (value && !list.includes(value)) {
            list.push(value);
          }
        });
        const normalized = setCompareList(list);
        applyListToSelects(normalized);
        return normalized;
      };

      const renderRadar = (agentList, systemId, dims) => {
        const system = systems.find((s) => s.id === systemId) || systems[0];
        const dimensions = system.dimensions.filter((dim) => dims.includes(dim.id));
        const size = 360;
        const pad = 50;
        const center = size / 2;
        const radius = 130;
        const colors = ['#2e8b57', '#5a64ff', '#f39b33', '#d64f7b', '#0ea5a8'];

        const polygonFor = (agent) =>
          dimensions
            .map((dim, index) => {
              const score = agent.scores.find((s) => s.systemId === systemId && s.dimensionId === dim.id)?.score || 0;
              const angle = (Math.PI * 2 * index) / dimensions.length - Math.PI / 2;
              const r = (score / 100) * radius;
              const x = center + r * Math.cos(angle);
              const y = center + r * Math.sin(angle);
              return `${x},${y}`;
            })
            .join(' ');

        comparisonRadar.innerHTML = `
          <svg width="${size}" height="${size}" viewBox="${-pad} ${-pad} ${size + pad * 2} ${size + pad * 2}" class="mx-auto" overflow="visible">
            <circle cx="${center}" cy="${center}" r="${radius}" fill="none" stroke="#d9d2c7" stroke-dasharray="4 4" />
            <circle cx="${center}" cy="${center}" r="${radius * 0.66}" fill="none" stroke="#e6dfd5" />
            <circle cx="${center}" cy="${center}" r="${radius * 0.33}" fill="none" stroke="#efe8dd" />
            ${dimensions
              .map((dim, index) => {
                const angle = (Math.PI * 2 * index) / dimensions.length - Math.PI / 2;
                const x = center + radius * Math.cos(angle);
                const y = center + radius * Math.sin(angle);
                const labelX = center + (radius + 26) * Math.cos(angle);
                const labelY = center + (radius + 26) * Math.sin(angle);
                return `
                  <line x1="${center}" y1="${center}" x2="${x}" y2="${y}" stroke="#e6dfd5" />
                  <text x="${labelX}" y="${labelY}" text-anchor="middle" dominant-baseline="middle" font-size="12" fill="#6f5435">
                    <title>${dim.name}</title>${dim.name}
                  </text>
                `;
              })
              .join('')}
            ${agentList
              .map(
                (agent, index) =>
                  `<polygon points="${polygonFor(agent)}" fill="${colors[index]}33" stroke="${colors[index]}" stroke-width="2" />`
              )
              .join('')}
          </svg>
        `;
      };

      const renderTable = (agentOne, agentTwo, systemId, dims) => {
        if (!agentOne || !agentTwo) {
          comparisonTable.innerHTML = '';
          return;
        }
        const system = systems.find((s) => s.id === systemId) || systems[0];
        const dimensions = system.dimensions.filter((dim) => dims.includes(dim.id));
        comparisonTable.innerHTML = '';
        dimensions.forEach((dim) => {
          const scoreA = agentOne.scores.find((s) => s.systemId === systemId && s.dimensionId === dim.id)?.score || 0;
          const scoreB = agentTwo.scores.find((s) => s.systemId === systemId && s.dimensionId === dim.id)?.score || 0;
          const delta = scoreA - scoreB;
          const row = document.createElement('tr');
          row.className = 'border-t border-ink-100';
          row.innerHTML = `
            <td class="py-3 pr-4">${dim.name}</td>
            <td class="py-3 pr-4">${scoreA}</td>
            <td class="py-3 pr-4">${scoreB}</td>
            <td class="py-3 ${delta >= 0 ? 'text-moss-700' : 'text-amber-700'}">${delta > 0 ? '+' : ''}${delta}</td>
          `;
          comparisonTable.appendChild(row);
        });
      };

      const renderLegend = (agentList) => {
        const colors = ['#2e8b57', '#5a64ff', '#f39b33', '#d64f7b', '#0ea5a8'];
        legend.innerHTML = '';
        agentList.forEach((agent, index) => {
          const item = document.createElement('div');
          item.className = 'flex items-center gap-2';
          item.innerHTML = `<span class="h-2 w-2 rounded-full" style="background:${colors[index]}"></span>${agent.name}`;
          legend.appendChild(item);
        });
      };

      const renderBars = (agentList, systemId, dims) => {
        const system = systems.find((s) => s.id === systemId) || systems[0];
        const dimensions = system.dimensions.filter((dim) => dims.includes(dim.id));
        const colors = ['#2e8b57', '#5a64ff', '#f39b33', '#d64f7b', '#0ea5a8'];
        comparisonBars.innerHTML = '';
        if (!agentList.length) {
          comparisonBars.innerHTML = '<div class="text-sm text-ink-500">No agents selected yet.</div>';
          return;
        }
        dimensions.forEach((dim) => {
          const row = document.createElement('div');
          row.className = 'space-y-2';
          const bars = agentList
            .map((agent, index) => {
              const score = agent.scores.find((s) => s.systemId === systemId && s.dimensionId === dim.id)?.score || 0;
              return `
                <div class="flex items-center gap-3">
                  <span class="w-20 text-xs text-ink-500">${agent.name}</span>
                  <div class="h-2 w-full rounded-full bg-ink-100">
                    <div class="h-2 rounded-full" style="width:${score}%;background:${colors[index]}"></div>
                  </div>
                  <span class="w-8 text-xs text-ink-600">${score}</span>
                </div>
              `;
            })
            .join('');
          row.innerHTML = `
            <div class="text-xs font-semibold uppercase tracking-wide text-ink-500">${dim.name}</div>
            <div class="space-y-2">${bars}</div>
          `;
          comparisonBars.appendChild(row);
        });
      };

      const renderAll = () => {
        const { system, dims } = getFilters();
        const list = agentSelects
          .map((select) => getAgent(select.value))
          .filter((agent) => agent);
        renderRadar(list, system, dims);
        renderTable(list[0] || null, list[1] || null, system, dims);
        renderLegend(list);
        renderBars(list, system, dims);
      };

      const clearSwapSelection = () => {
        swapSelection = [];
        compareAgentsGrid.querySelectorAll('[data-agent-slot]').forEach((slot) => {
          slot.classList.remove('ring-2', 'ring-ink-900', 'bg-ink-50/70');
        });
      };

      const setSwapActive = (active) => {
        swapActive = active;
        swapAgents.classList.toggle('bg-ink-900', active);
        swapAgents.classList.toggle('text-ink-50', active);
        swapAgents.classList.toggle('hover:bg-ink-900', active);
        swapAgents.style.color = active ? '#f8f5ef' : '';
        swapAgents.setAttribute('aria-pressed', active ? 'true' : 'false');
        if (!active) {
          clearSwapSelection();
        }
        updateSwapHints();
        updateSwapLockState();
      };

      applyListToSelects(getCompareList());
      renderAll();
      setSwapActive(false);

      agentSelects.forEach((select) => select.addEventListener('change', () => {
        syncCompareFromSelects();
        renderAll();
      }));
      swapAgents.addEventListener('click', () => {
        setSwapActive(!swapActive);
      });

      compareAgentsGrid.addEventListener('click', (event) => {
        const removeButton = event.target.closest('[data-compare-slot-remove]');
        if (removeButton) {
          const index = Number(removeButton.dataset.compareSlotRemove);
          const list = getCompareList();
          if (!Number.isNaN(index)) {
            list.splice(index, 1);
            const normalized = setCompareList(list);
            applyListToSelects(normalized);
            renderAll();
          }
          return;
        }
        if (!swapActive) return;
        const slot = event.target.closest('[data-agent-slot]');
        if (!slot) return;
        event.preventDefault();
        event.stopPropagation();
        const index = Number(slot.dataset.agentSlotIndex);
        if (Number.isNaN(index) || swapSelection.includes(index)) return;
        if (!agentSelects[index]?.value) return;
        swapSelection.push(index);
        slot.classList.add('ring-2', 'ring-ink-900', 'bg-ink-50/70');
        if (swapSelection.length === 2) {
          const [firstIndex, secondIndex] = swapSelection;
          const firstSelect = agentSelects[firstIndex];
          const secondSelect = agentSelects[secondIndex];
          const temp = firstSelect.value;
          firstSelect.value = secondSelect.value;
          secondSelect.value = temp;
          syncCompareFromSelects();
          renderAll();
          clearSwapSelection();
        }
      });

      window.addEventListener('avb:filters', renderAll);
      window.addEventListener('avb:tab', (event) => {
        if (event.detail === 'comparison') {
          applyListToSelects(getCompareList());
          renderAll();
          setSwapActive(false);
        }
      });

      if (systemSelect) {
        systemSelect.addEventListener('change', () => requestAnimationFrame(renderAll));
      }
      if (dimensionList) {
        dimensionList.addEventListener('change', renderAll);
      }
    })();
  </script>
</BenchmarkLayout>
