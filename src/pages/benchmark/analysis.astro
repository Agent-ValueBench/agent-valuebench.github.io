---
import BenchmarkLayout from '../../layouts/BenchmarkLayout.astro';
import { agents, valueSystems, cases } from '../../data/benchmark';
const serializedAgents = JSON.stringify(agents);
const serializedSystems = JSON.stringify(valueSystems);
const serializedCases = JSON.stringify(cases);
---
<BenchmarkLayout activeTab="analysis">
  <div class="space-y-10">
    <section class="card p-6">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <div class="text-xs uppercase tracking-wide text-ink-500">Agent Analysis</div>
          <div class="mt-2 font-display text-2xl font-semibold text-ink-900">Single agent profile</div>
        </div>
        <button class="btn-ghost" type="button">Download (this agent results)</button>
      </div>
      <div class="mt-6 grid gap-6 lg:grid-cols-[240px,1fr]">
        <div>
          <label class="text-xs uppercase tracking-wide text-ink-500">Select Agent</label>
          <select id="agentSelect" class="mt-2 w-full rounded-xl border border-ink-200 bg-white/80 px-3 py-2 text-sm">
            {agents.map((agent) => (
              <option value={agent.id}>{agent.name}</option>
            ))}
          </select>
          <div class="mt-4 space-y-2 text-sm text-ink-600" id="agentMeta"></div>
        </div>
        <div class="grid gap-6 lg:grid-cols-2">
          <div class="rounded-2xl border border-ink-100 bg-white/80 p-5">
            <div class="text-sm font-semibold text-ink-800">Radar: Value dimensions</div>
            <div class="mt-4" id="radarChart"></div>
          </div>
          <div class="rounded-2xl border border-ink-100 bg-white/80 p-5">
            <div class="text-sm font-semibold text-ink-800">Bars: Dimension scores</div>
            <div class="mt-4 space-y-3" id="barChart"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="card p-6">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <div class="text-xs uppercase tracking-wide text-ink-500">Case Evidence</div>
          <div class="mt-2 font-display text-2xl font-semibold text-ink-900">Model behavior snapshots</div>
        </div>
        <div class="text-sm text-ink-500">Placeholder cases (future evidence support)</div>
      </div>
      <div class="mt-6 grid gap-4 md:grid-cols-2" id="caseList"></div>
      <div class="mt-6 flex items-center justify-end gap-2 text-sm">
        <button class="btn-ghost" type="button">Previous</button>
        <button class="btn-ghost" type="button">Next</button>
      </div>
    </section>
  </div>

  <script>
    const agents = JSON.parse(`{"agents":${serializedAgents}}`).agents;
    const systems = JSON.parse(`{"systems":${serializedSystems}}`).systems;
    const cases = JSON.parse(`{"cases":${serializedCases}}`).cases;

    const agentSelect = document.getElementById('agentSelect');
    const agentMeta = document.getElementById('agentMeta');
    const radarChart = document.getElementById('radarChart');
    const barChart = document.getElementById('barChart');
    const caseList = document.getElementById('caseList');

    const getFilters = () => {
      const params = new URLSearchParams(window.location.search);
      const stored = JSON.parse(localStorage.getItem('avb-filters') || 'null');
      return {
        system: params.get('system') || stored?.system || systems[0].id,
        dims: params.get('dims')?.split(',') || stored?.dims || [],
      };
    };

    const getAgent = (id) => agents.find((agent) => agent.id === id) || agents[0];

    const renderMeta = (agent) => {
      agentMeta.innerHTML = `
        <div><strong>Developer:</strong> ${agent.developer}</div>
        <div><strong>Website/GitHub:</strong> <a class="underline" href="${agent.website}">${agent.website}</a></div>
        <div><strong>Paper/report:</strong> <a class="underline" href="${agent.paper}">${agent.paper}</a></div>
        <div><strong>Type:</strong> ${agent.type}</div>
        <div><strong>Publish date:</strong> ${agent.releaseDate}</div>
        <div><strong>Measurement date:</strong> ${agent.measurementDate}</div>
      `;
    };

    const renderRadar = (agent, systemId, dims) => {
      const system = systems.find((s) => s.id === systemId) || systems[0];
      const dimensions = system.dimensions.filter((dim) => !dims.length || dims.includes(dim.id));
      const size = 220;
      const center = size / 2;
      const radius = 80;
      const points = dimensions.map((dim, index) => {
        const score = agent.scores.find((s) => s.systemId === systemId && s.dimensionId === dim.id)?.score || 0;
        const angle = (Math.PI * 2 * index) / dimensions.length - Math.PI / 2;
        const r = (score / 100) * radius;
        return {
          x: center + r * Math.cos(angle),
          y: center + r * Math.sin(angle),
          labelX: center + (radius + 18) * Math.cos(angle),
          labelY: center + (radius + 18) * Math.sin(angle),
          label: dim.name,
        };
      });

      const polygon = points.map((p) => `${p.x},${p.y}`).join(' ');

      radarChart.innerHTML = `
        <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" class="mx-auto">
          <circle cx="${center}" cy="${center}" r="${radius}" fill="none" stroke="#d9d2c7" stroke-dasharray="4 4" />
          <circle cx="${center}" cy="${center}" r="${radius * 0.66}" fill="none" stroke="#e6dfd5" />
          <circle cx="${center}" cy="${center}" r="${radius * 0.33}" fill="none" stroke="#efe8dd" />
          ${points
            .map(
              (p) => `<line x1="${center}" y1="${center}" x2="${p.x}" y2="${p.y}" stroke="#e6dfd5" />`
            )
            .join('')}
          <polygon points="${polygon}" fill="rgba(46, 139, 87, 0.35)" stroke="#2e8b57" stroke-width="2" />
          ${points
            .map(
              (p) => `<text x="${p.labelX}" y="${p.labelY}" text-anchor="middle" font-size="10" fill="#6f5435">${p.label}</text>`
            )
            .join('')}
        </svg>
      `;
    };

    const renderBars = (agent, systemId, dims) => {
      const system = systems.find((s) => s.id === systemId) || systems[0];
      const dimensions = system.dimensions.filter((dim) => !dims.length || dims.includes(dim.id));
      barChart.innerHTML = '';
      dimensions.forEach((dim) => {
        const score = agent.scores.find((s) => s.systemId === systemId && s.dimensionId === dim.id)?.score || 0;
        const row = document.createElement('div');
        row.innerHTML = `
          <div class="flex items-center justify-between text-xs text-ink-600">
            <span>${dim.name}</span>
            <span>${score}</span>
          </div>
          <div class="mt-2 h-2 rounded-full bg-ink-100">
            <div class="h-2 rounded-full bg-ink-900" style="width: ${score}%;"></div>
          </div>
        `;
        barChart.appendChild(row);
      });
    };

    const renderCases = (systemId, dims) => {
      const filtered = cases.filter((item) => item.systemId === systemId && (!dims.length || dims.includes(item.dimensionId)));
      caseList.innerHTML = '';
      (filtered.length ? filtered : cases).forEach((item) => {
        const card = document.createElement('div');
        card.className = 'rounded-2xl border border-ink-100 bg-white/80 p-4';
        card.innerHTML = `
          <div class="text-xs uppercase tracking-wide text-ink-400">Case score ${item.score}</div>
          <div class="mt-2 text-sm font-semibold text-ink-800">${item.question}</div>
          <div class="mt-2 text-xs text-ink-600">${item.summary}</div>
          <button class="mt-4 rounded-full border border-ink-200 px-3 py-1 text-xs font-semibold">Copy</button>
        `;
        caseList.appendChild(card);
      });
    };

    const syncAgentFromQuery = () => {
      const params = new URLSearchParams(window.location.search);
      const agentId = params.get('agent');
      if (agentId && agents.find((a) => a.id === agentId)) {
        agentSelect.value = agentId;
      }
    };

    const renderAll = () => {
      const { system, dims } = getFilters();
      const agent = getAgent(agentSelect.value);
      renderMeta(agent);
      renderRadar(agent, system, dims);
      renderBars(agent, system, dims);
      renderCases(system, dims);
    };

    syncAgentFromQuery();
    renderAll();

    agentSelect.addEventListener('change', () => {
      const params = new URLSearchParams(window.location.search);
      params.set('agent', agentSelect.value);
      window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);
      renderAll();
    });
  </script>
</BenchmarkLayout>
